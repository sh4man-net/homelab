apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: truenas-nfs
  namespace: democratic-csi
spec:
  interval: 30m
  chart:
    spec:
      chart: democratic-csi
      version: '>=0.14.0'
      sourceRef:
        kind: HelmRepository
        name: democratic-csi
        namespace: democratic-csi
      interval: 12h
  valuesFrom:
  - kind: Secret
    name: truenas-api-key
    valuesKey: apiKey
    targetPath: driver.config.httpConnection.apiKey
  values:
    csiDriver:
      name: "org.democratic-csi.nfs"

    storageClasses:
    - name: truenas-nfs
      defaultClass: true
      reclaimPolicy: Retain
      volumeBindingMode: Immediate
      allowVolumeExpansion: true
      parameters:
        fsType: nfs
      mountOptions:
      - nfsvers=4
      - nconnect=8
      - hard
      - noatime
      secrets:
        provisioner-secret:
        controller-publish-secret:
        node-stage-secret:
        node-publish-secret:
        controller-expand-secret:
    volumeSnapshotClasses: []

    driver:
      config:
        driver: freenas-nfs
        instance_id:
        httpConnection:
          protocol: http  # Change to https if SSL configured
          host: 192.168.178.59  # YOUR TRUENAS IP
          port: 80  # Change to 443 for https
          allowInsecure: true
        zfs:
          datasetParentName: treasure-chest/k8s/volumes  # CHANGE THIS
          detachedSnapshotsDatasetParentName: "treasure-chest/k8s/snapshots"
          datasetEnableQuotas: true
          datasetEnableReservation: false
          datasetPermissionsMode: "0777"
          datasetPermissionsUser: 0
          datasetPermissionsGroup: 0
        nfs:
          shareHost: 192.168.178.59  # YOUR TRUENAS IP
          shareAlldirs: false
          shareAllowedHosts: []
          shareAllowedNetworks: []
          shareMaprootUser: truenas_admin
          shareMaprootGroup: truenas_admin
          shareMapallUser: ""
          shareMapallGroup: ""

    controller:
      enabled: true
      driver:
        logLevel: debug  # Add this
        extraEnv:
        - name: GRPC_TRACE
          value: "all"
        - name: GRPC_VERBOSITY
          value: "DEBUG"
        image:
          registry: docker.io/democraticcsi/democratic-csi
          tag: latest
          pullPolicy: IfNotPresent
      externalProvisioner:
        enabled: true
        image:
          registry: registry.k8s.io/sig-storage/csi-provisioner
          tag: v3.6.0
          pullPolicy: IfNotPresent
      externalResizer:
        enabled: true
        image:
          registry: registry.k8s.io/sig-storage/csi-resizer
          tag: v1.9.0
          pullPolicy: IfNotPresent
      externalSnapshotter:
        enabled: false
      externalAttacher:
        enabled: false

    node:
      enabled: true
      driver:
        image:
          registry: docker.io/democraticcsi/democratic-csi
          tag: latest
          pullPolicy: IfNotPresent
      driverRegistrar:
        enabled: true
        image:
          registry: registry.k8s.io/sig-storage/csi-node-driver-registrar
          tag: v2.9.0
          pullPolicy: IfNotPresent
      hostPID: true
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/control-plane
        operator: Exists
